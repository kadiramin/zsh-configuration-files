# zsh: true

# --- Git Aliases, Functions, and Helper Scripts for macOS M4 ---
# These are shorthand aliases and functions to simplify commonly used Git operations

# --- Git Short-hands ---
alias g='git'  # Shortcut for 'git'
alias gfu='git fetch upstream'  # Fetch from the upstream remote (useful for forked repositories)
alias gfo='git fetch origin'    # Fetch from the origin remote (the main repo)
alias gp='git pull'             # Pull the latest changes from the remote repo
alias gs='git status'           # Display the status of the git repository
alias gc='git checkout'         # Checkout a branch or commit
alias gl="git log --pretty=format:'%Cblue%h%Creset%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)%an%Creset' --abbrev-commit --date=relative"  # Custom git log format (includes hash, date, author)
alias gnb='git checkout -b'     # Create a new branch and switch to it
alias gcomam='git add -A && git commit -m'  # Add all changes and commit with a message
alias gcommend='git add -A && git commit --amend --no-edit'  # Amend the last commit without changing the message
alias gm='git merge'            # Merge another branch into the current branch
alias gcp='git cherry-pick'     # Apply the changes from a specific commit to the current branch
alias set-up='git branch --set-upstream-to=origin/main'  # Set upstream branch to the main branch of origin

# --- Directory Shortcuts ---
# Shortcuts to quickly navigate to common directories

alias cdr='cd ~/Repos/'              # Navigate to the 'Repos' directory
alias cddi='cd ~/Repos/docs-internal' # Navigate to the 'docs-internal' directory
alias cdds='cd ~/Repos/docs-strategy' # Navigate to the 'docs-strategy' directory

# --- Helper Functions ---

# Get the default branch name of the current GitHub repository using GitHub CLI (gh)
git_default_branch() {
  if (( ! $+commands[gh] )); then  # Check if 'gh' (GitHub CLI) is installed
    echo "GitHub CLI (gh) not found. Defaulting to 'main'."  # If not, default to 'main'
    return 1
  fi
  # Get the default branch name from the GitHub repo using 'gh'
  gh repo view --json defaultBranchRef -q '.defaultBranchRef.name' 2>/dev/null || echo "main"
}

# Checkout the default branch of the repository
unalias gcm 2>/dev/null || true  # Unalias 'gcm' if it already exists to avoid conflict
gcm() {
  local def=$(git_default_branch)  # Get the default branch (e.g., 'main' or 'master')
  [[ -z "$def" ]] && def="main"  # Default to 'main' if no branch is returned
  git rev-parse --git-dir >/dev/null 2>&1 || { echo "Not a git repo."; return 1 }  # Ensure we are in a git repo
  git checkout "$def"  # Checkout the default branch
}

# Push the current branch to origin with a warning if pushing to the default branch
gpoh() {
  git rev-parse --git-dir >/dev/null 2>&1 || { echo "Not a git repo."; return 1 }  # Ensure we are in a git repo
  local curr=$(git rev-parse --abbrev-ref HEAD)  # Get the current branch
  local def=$(git_default_branch)  # Get the default branch
  
  if [[ "$curr" == "${def:-main}" ]]; then  # If we're on the default branch (e.g., 'main')
    echo "WARNING: Pushing to default branch ($def)!"  # Warning message
    read -r "resp?Are you sure? [y/N] "  # Ask for confirmation before pushing
    [[ ! $resp =~ ^[Yy]$ ]] && { echo "Cancelled."; return 1 }  # If not confirmed, cancel the push
  fi
  git push -u origin HEAD  # Push to origin
}

# Update the current branch with changes from the default branch (usually 'main')
brupdate() {
  # Set default options (dry-run, quiet, push enabled by default)
  local DRY_RUN=false PUSH=true QUIET=false 
  local BLUE="\e[1;34m" YELLOW="\e[1;33m" GREEN="\e[1;32m" RED="\e[1;31m" RESET="\e[0m"

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run) DRY_RUN=true; shift ;;  # Dry run: Only show the changes, don't apply them
      --no-prompt-push) PUSH=false; shift ;;  # Don't ask to push after the update
      --quiet) QUIET=true; shift ;;  # Suppress verbose output
      *) echo "Unknown option: $1"; return 1 ;;  # Handle invalid options
    esac
  done

  git rev-parse --git-dir >/dev/null 2>&1 || { echo "${RED}Not a git repo.${RESET}"; return 1 }  # Ensure we're in a git repo
  
  local def=$(git_default_branch)  # Get the default branch
  local curr=$(git rev-parse --abbrev-ref HEAD)  # Get the current branch
  
  # Fetch the latest changes from the origin repository
  [[ $QUIET != true ]] && echo "${BLUE}Fetching origin...${RESET}"
  git fetch origin --quiet

  if [[ $DRY_RUN == true ]]; then  # If it's a dry run, show the commits that will be merged
    git log --oneline "$curr"..origin/"${def:-main}"
    return 0
  fi

  # Attempt to merge the default branch into the current branch
  if ! git merge origin/"${def:-main}" -m "Merge '${def:-main}' into $curr"; then
    echo "${RED}Conflicts detected.${RESET}"; return 1  # Abort if there are conflicts
  fi

  # If push is enabled, ask the user to confirm and push the changes
  if [[ $PUSH == true ]]; then
    read -r "confirm?Push to GitHub? [y/N] "
    [[ $confirm =~ ^[Yy]$ ]] && git push -u  # Push the changes if confirmed
  fi
}
